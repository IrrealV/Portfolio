---
import Layout from '../layouts/Layout.astro';
import Section from '../components/ui/Section.astro';
import Timeline from '../components/ui/Timeline.astro';
import ProjectCard from '../components/ui/ProjectCard.astro';
import TechPill from '../components/ui/TechPill.astro';
import Typewriter from '../components/ui/Typewriter.astro';
import SocialIcon from '../components/ui/SocialIcon.astro';
import {
  SITE_INFO,
  SOCIALS,
  STACK,
  EXPERIENCE,
  EDUCATION,
  PROJECTS,
} from '../data/info';
---

<Layout>
  <!-- Hero Section -->
  <header class="pb-12 border-b border-(--color-border)">
    <div
      class="flex flex-col-reverse md:flex-row md:items-center md:justify-between gap-8"
    >
      <!-- Text Content -->
      <div class="flex-1">
        <h1
          class="text-4xl sm:text-5xl lg:text-6xl font-bold tracking-tight mb-3 text-(--color-text)"
        >
          VÃ­ctor Manuel Heras
        </h1>
        <p
          class="text-2xl sm:text-3xl font-semibold text-(--color-accent) mb-6 min-h-10"
        >
          <Typewriter />
        </p>

        <!-- Social Links with Icons -->
        <div class="flex items-center gap-3 flex-wrap">
          {
            SOCIALS.map((social) => (
              <a
                href={social.url}
                target="_blank"
                rel="noopener noreferrer"
                class="flex items-center gap-2 px-4 py-2 rounded-lg bg-(--color-bg-secondary) border border-(--color-border) text-(--color-text-secondary) hover:text-(--color-accent) hover:border-(--color-accent) transition-all duration-300"
              >
                <SocialIcon
                  name={social.icon as 'github' | 'linkedin'}
                  class="w-5 h-5"
                />
                <span class="text-sm font-medium">{social.name}</span>
              </a>
            ))
          }
        </div>
      </div>

      <!-- Profile Photo with Flip Effect -->
      <div class="shrink-0">
        <div class="relative group perspective-1000">
          <!-- Decorative ring -->
          <div
            class="absolute inset-0 rounded-full border-2 border-(--color-accent) opacity-50 scale-110 z-10 pointer-events-none"
          >
          </div>

          <!-- Flip Card Container -->
          <div class="flip-card w-32 h-32 md:w-40 md:h-40 lg:w-48 lg:h-48">
            <div class="flip-card-inner group-hover:rotate-y-180">
              <!-- Front - Profile Photo -->
              <div
                class="flip-card-front rounded-full overflow-hidden border-4 border-(--color-border) shadow-xl"
              >
                <img
                  src="/perfil.jpg"
                  alt="VÃ­ctor Manuel Heras"
                  class="w-full h-full object-cover"
                />
              </div>
              <!-- Back - Logo/Favicon (clickable for easter egg) -->
              <button
                id="gravity-trigger"
                type="button"
                class="flip-card-back rounded-full border-4 border-(--color-accent) shadow-xl bg-(--color-bg-secondary) flex items-center justify-center cursor-pointer hover:scale-105 transition-transform"
                aria-label="Easter egg"
              >
                <img
                  src="/favicon.svg"
                  alt="Logo"
                  class="w-1/2 h-1/2 object-contain pointer-events-none"
                />
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Sobre mÃ­ -->
  <Section title="Sobre mÃ­" id="about">
    <div class="max-w-4xl">
      <p class="text-(--color-text-secondary) leading-relaxed text-lg mb-4">
        Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod
        tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim
        veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea
        commodo consequat.
      </p>
      <p class="text-(--color-text-secondary) leading-relaxed text-lg">
        Duis aute irure dolor in reprehenderit in voluptate velit esse cillum
        dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non
        proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
      </p>
    </div>
  </Section>

  <!-- Experiencia & EducaciÃ³n - Side by Side on Desktop -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-16 py-16">
    <!-- Experiencia -->
    <div>
      <h2
        class="text-2xl font-bold mb-8 text-(--color-text) flex items-center gap-3"
      >
        <span
          class="w-8 h-8 rounded-lg bg-(--color-accent) flex items-center justify-center text-white text-sm"
          >ðŸ’¼</span
        >
        Experiencia
      </h2>
      <Timeline items={EXPERIENCE} type="experience" />
    </div>

    <!-- EducaciÃ³n -->
    <div>
      <h2
        class="text-2xl font-bold mb-8 text-(--color-text) flex items-center gap-3"
      >
        <span
          class="w-8 h-8 rounded-lg bg-(--color-accent) flex items-center justify-center text-white text-sm"
          >ðŸŽ“</span
        >
        EducaciÃ³n
      </h2>
      <Timeline items={EDUCATION} type="education" />
    </div>
  </div>

  <!-- Proyectos -->
  <Section title="Proyectos" id="projects">
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
      {PROJECTS.map((project) => <ProjectCard project={project} />)}
    </div>
  </Section>

  <!-- Stack -->
  <Section title="Stack" id="stack">
    <p class="text-(--color-text-muted) mb-6">
      TecnologÃ­as con las que trabajo habitualmente
    </p>
    <div class="flex flex-wrap gap-3">
      {
        STACK.map((tech) => (
          <TechPill name={tech.name} colorClass={tech.colorClass} />
        ))
      }
    </div>
  </Section>

  <!-- Contact CTA -->
  <section class="py-20 text-center">
    <div class="max-w-2xl mx-auto">
      <h2 class="text-3xl font-bold mb-4 text-(--color-text)">Â¿Hablamos?</h2>
      <p class="text-(--color-text-secondary) mb-8 text-lg">
        Estoy abierto a nuevas oportunidades y colaboraciones.
      </p>
      <a
        href={`mailto:${SITE_INFO.email}`}
        class="inline-flex items-center gap-3 px-8 py-4 bg-(--color-accent) text-white font-semibold rounded-xl hover:opacity-90 transition-all duration-300 shadow-lg hover:shadow-xl hover:scale-105"
      >
        <SocialIcon name="email" class="w-5 h-5" />
        ContÃ¡ctame
      </a>
    </div>
  </section>
</Layout>

<script>
  // ðŸŽ® GRAVITY EASTER EGG
  // Click the logo on the back of the flipped profile photo to activate!

  function initGravityEasterEgg() {
    const trigger = document.getElementById('gravity-trigger');
    if (!trigger) return;

    let isGravityActive = false;

    trigger.addEventListener('click', (e) => {
      e.preventDefault();

      if (isGravityActive) {
        // Reset everything
        resetGravity();
        return;
      }

      isGravityActive = true;
      activateGravity();
    });

    function activateGravity() {
      // Get all major elements to apply gravity to
      const elements = document.querySelectorAll(
        'section, header, .flip-card, h1, h2, p, a:not(#gravity-trigger), button:not(#gravity-trigger), span, div.flex > div, .timeline-item, img:not(.flip-card-back img)',
      );

      const bodies: Array<{
        el: HTMLElement;
        x: number;
        y: number;
        vx: number;
        vy: number;
        rotation: number;
        vr: number;
        originalTransform: string;
        originalPosition: string;
      }> = [];

      elements.forEach((el) => {
        const element = el as HTMLElement;
        const rect = element.getBoundingClientRect();

        // Skip very small or hidden elements
        if (rect.width < 20 || rect.height < 20) return;

        // Skip nested elements (only apply to first-level visible elements)
        if (element.closest('.falling-element')) return;

        bodies.push({
          el: element,
          x: rect.left + window.scrollX,
          y: rect.top + window.scrollY,
          vx: (Math.random() - 0.5) * 5,
          vy: 0,
          rotation: 0,
          vr: (Math.random() - 0.5) * 10,
          originalTransform: element.style.transform,
          originalPosition: element.style.position,
        });

        element.classList.add('falling-element');
        element.style.position = 'fixed';
        element.style.zIndex = '9999';
        element.style.left = rect.left + 'px';
        element.style.top = rect.top + 'px';
        element.style.width = rect.width + 'px';
        element.style.transition = 'none';
      });

      const gravity = 0.5;
      const bounce = 0.6;
      const friction = 0.99;
      const floor = window.innerHeight - 50;

      let animationId: number = 0;

      function animate() {
        bodies.forEach((body) => {
          // Apply gravity
          body.vy += gravity;

          // Apply velocity
          body.x += body.vx;
          body.y += body.vy;
          body.rotation += body.vr;

          // Friction
          body.vx *= friction;
          body.vr *= friction;

          // Floor collision
          const rect = body.el.getBoundingClientRect();
          if (body.y + rect.height > floor) {
            body.y = floor - rect.height;
            body.vy = -body.vy * bounce;
            body.vr *= bounce;

            // Stop bouncing if velocity is low
            if (Math.abs(body.vy) < 1) {
              body.vy = 0;
            }
          }

          // Wall collision
          if (body.x < 0) {
            body.x = 0;
            body.vx = -body.vx * bounce;
          }
          if (body.x + rect.width > window.innerWidth) {
            body.x = window.innerWidth - rect.width;
            body.vx = -body.vx * bounce;
          }

          // Apply transforms
          body.el.style.left = body.x + 'px';
          body.el.style.top = body.y + 'px';
          body.el.style.transform = `rotate(${body.rotation}deg)`;
        });

        animationId = requestAnimationFrame(animate);
      }

      animate();

      // Store animation ID for cleanup
      (window as any).gravityAnimationId = animationId;
      (window as any).gravityBodies = bodies;
    }

    function resetGravity() {
      isGravityActive = false;

      // Cancel animation
      if ((window as any).gravityAnimationId) {
        cancelAnimationFrame((window as any).gravityAnimationId);
      }

      // Reset all elements
      const bodies = (window as any).gravityBodies || [];
      bodies.forEach((body: any) => {
        body.el.classList.remove('falling-element');
        body.el.style.position = body.originalPosition;
        body.el.style.transform = body.originalTransform;
        body.el.style.left = '';
        body.el.style.top = '';
        body.el.style.width = '';
        body.el.style.zIndex = '';
        body.el.style.transition = '';
      });

      // Reload page to fully reset
      window.location.reload();
    }
  }

  // Initialize on page load and after View Transitions
  initGravityEasterEgg();
  document.addEventListener('astro:after-swap', initGravityEasterEgg);
</script>

<style>
  .falling-element {
    pointer-events: none !important;
  }
</style>
